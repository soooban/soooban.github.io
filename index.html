<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="default">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="记录小伙伴们的分享">
<meta property="og:type" content="website">
<meta property="og:title" content="CREAMS 小组">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="CREAMS 小组">
<meta property="og:description" content="记录小伙伴们的分享">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CREAMS 小组">
<meta name="twitter:description" content="记录小伙伴们的分享">





  
  
  <link rel="canonical" href="http://yoursite.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>CREAMS 小组</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">CREAMS 小组</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/12/RabbitMQ-延时消息的应用与实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/03/12/RabbitMQ-延时消息的应用与实现/" class="post-title-link" itemprop="url">RabbitMQ 延时消息的应用与实现</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-03-12 15:31:02 / Modified: 15:37:20" itemprop="dateCreated datePublished" datetime="2020-03-12T15:31:02+08:00">2020-03-12</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2020/03/12/RabbitMQ-延时消息的应用与实现/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2020/03/12/RabbitMQ-延时消息的应用与实现/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2020/03/12/RabbitMQ-延时消息的应用与实现/" class="leancloud_visitors" data-flag-title="RabbitMQ 延时消息的应用与实现">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在实际的业务开发中，经常会碰到一些类似定时的任务，比如每天早上 9 点提醒用户业务进度，或者 30 分钟后锁定某个账单之类的操作。类似这样的业务需求，比较古老的操作就是使用各种定时器来实现，然而面对现在的开发更新速度，以及容器化、微服务架构的流行和普及，原本类似 <code>Crontab</code> 这种简单的东西使用起来会有各种限制，比如在最简单的情况你可以使用 <code>Spring</code> 的 <code>@Scheduled</code> 注解来轻松的实现一些定时需求，但现在你可能就需要考虑多如何将定时任务分配给多个节点，某个时间重新构建容器会不会丢失一些定时任务等等一些问题。这种情况延迟消息能解决掉我们大部分的需求，大概的流程就是丢一个消息给中间件，告诉它什么时候投递出去，投递后再由消费端消费（负责去通知/发邮件/发短信）。由于我们公司一直使用的 <code>Spring Cloud</code> 全家桶，<code>RabbitMQ</code> 也已经使用很多年，这里就讲讲如何在<code>Spring Cloud Stream RabbitMQ</code>下以最小的成本实现延时消息，所以在阅读文章时可能需要有 <code>Spring Cloud Stream</code> 相关的基础知识。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>实际上 <code>RabbitMQ</code> 的延迟消息是通过 <code>rabbitmq-delayed-message-exchange</code> 这个插件实现的，开启了这个插件之后，只要在 <code>exchange</code> 上定义 <code>x-delayed-message</code> 类型，然后在发送消息的时候 <code>header</code> 带上 <code>x-delay</code> (毫秒数)，就可以实现延迟消息。我们可以利用这一特性，来实现消息的延迟/定时发送。<br><img src="https://jokefaker.oss-cn-hangzhou.aliyuncs.com/article/rabbitmq-delay.png" alt><br>理想的模型是这个样子的，但实际在应用中难免会有一些出入，在文末问题区会做一些相关的讨论。</p>
<h3 id="RabbieMQ-插件安装"><a href="#RabbieMQ-插件安装" class="headerlink" title="RabbieMQ 插件安装"></a>RabbieMQ 插件安装</h3><p>由于我们的 RabbitMQ 服务器都是跑在 <code>Docker</code> 容器里，所以这里就相对简单，新建一个 Dockerfile：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FROM rabbitmq:3.7.8-management-alpine</span><br><span class="line"></span><br><span class="line">RUN cd /plugins \</span><br><span class="line">&amp;&amp; wget https://dl.bintray.com/rabbitmq/community-plugins/3.7.x/rabbitmq_delayed_message_exchange/rabbitmq_delayed_message_exchange-20171201-3.7.x.zip \</span><br><span class="line">&amp;&amp; unzip rabbitmq_delayed_message_exchange-20171201-3.7.x.zip \</span><br><span class="line">&amp;&amp; rm rabbitmq_delayed_message_exchange-20171201-3.7.x.zip \</span><br><span class="line">&amp;&amp; rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure>

<p>如果你使用的是 3.8.x 版本，注意修改对应的版本。另外要是不跑在容器当中，<code>RabbitMQ</code> 官网也有说明，这里就不再赘述。</p>
<h3 id="Sprint-Cloud-Stream-优化"><a href="#Sprint-Cloud-Stream-优化" class="headerlink" title="Sprint Cloud Stream 优化"></a>Sprint Cloud Stream 优化</h3><p><code>stream</code> 配置有以下几个问题：</p>
<ul>
<li>需要在配置中编写 <code>destination</code> 等配置，然而这些配置往往都是模板化的</li>
<li>配置完毕后，代码中还需要将 channel 和 bean  的名称对应上，属于 hard code，如果对不上，或者某一边忘记删除，都会出错</li>
</ul>
<p>实际上在我们整个微服务的使用来看，大部分的配置内容都是一样的，我们先来看一下比较常见的模板：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">xxx-events: # 这里是 input</span><br><span class="line">	group: yyy-service</span><br><span class="line">	contentType: application/json # 新的 stream 版本可以提供默认配置，不用每个指定</span><br><span class="line">	durableSubscription: true</span><br><span class="line">yyy-events: # 这里是 output</span><br><span class="line">	destination: yyy-events</span><br><span class="line">	contentType: application/json # 新的 stream 版本可以提供默认配置，不用每个指定</span><br></pre></td></tr></table></figure>

<p>如果一个 service 以领域事件向外输出消息，那么 <code>RabbitMQ</code> 的模板长成这个样子是比较常见的，统一由 yyy-events 发出领域事件，通过 xxx-events（各种领域）来接收领域事件。这样实际我们只需要根据服务的名称去生成对应的配置即可，如果你自己的业务有所不同，则需要根据自己的使用方式来生成配置。</p>
<p>下面给出实现上述配置的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ConditionalOnClass(RabbitServiceAutoConfiguration.class)</span><br><span class="line">public class StreamAutoConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ConfigurableEnvironment environment;</span><br><span class="line"></span><br><span class="line">    private static final String PROPERTY_SOURCE_NAME = &quot;creams-stream-rabbit-spring-boot-starter:stream-rabbit-config-properties&quot;;</span><br><span class="line"></span><br><span class="line">    private static final String RABBIT_PREFIX = &quot;spring.cloud.stream.rabbit.bindings.&quot;;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private ApplicationContext context;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    @Primary</span><br><span class="line">    BindingServiceProperties customProps(BindingServiceProperties bindingServiceProperties) &#123;</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; beanMap = context.getBeansWithAnnotation(EnableBinding.class);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        beanMap.forEach((key, value) -&gt; &#123;</span><br><span class="line">            EnableBinding annotation = context.findAnnotationOnBean(key, EnableBinding.class);</span><br><span class="line">            if (annotation != null) &#123;</span><br><span class="line">                setPropsForAnnotation(annotation, map, bindingServiceProperties);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        addOrReplace(environment.getPropertySources(), map);</span><br><span class="line"></span><br><span class="line">        return bindingServiceProperties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private void setPropsForAnnotation(EnableBinding annotation, Map&lt;String, Object&gt; map, BindingServiceProperties bindingServiceProperties) &#123;</span><br><span class="line">        Stream.of(annotation.value()).forEach(type -&gt; ReflectionUtils.doWithMethods(type, method -&gt; &#123;</span><br><span class="line">            Input input = AnnotationUtils.findAnnotation(method, Input.class);</span><br><span class="line">            Output output = AnnotationUtils.findAnnotation(method, Output.class);</span><br><span class="line">            Destination destination = AnnotationUtils.findAnnotation(method, Destination.class);</span><br><span class="line"></span><br><span class="line">            String destinationName = Optional.ofNullable(destination).map(Destination::destination).orElse(&quot;&quot;);</span><br><span class="line">            if (input != null) &#123;</span><br><span class="line">                // 设置 input 的内容</span><br><span class="line">                if (StringUtils.isEmpty(destinationName)) &#123;</span><br><span class="line">                    destinationName = input.value();</span><br><span class="line">                &#125;</span><br><span class="line">                String name = BindingBeanDefinitionRegistryUtils</span><br><span class="line">                    .getBindingTargetName(input, method);</span><br><span class="line">                BindingProperties properties = bindingServiceProperties.getBindingProperties(name);</span><br><span class="line">                properties.setGroup(getApplicationName());</span><br><span class="line">                properties.setDestination(destinationName);</span><br><span class="line">                String rabbitPrefix = RABBIT_PREFIX + name + &quot;.consumer&quot;;</span><br><span class="line">                map.put(rabbitPrefix + &quot;.autoBindDlq&quot;, true);</span><br><span class="line">                map.put(rabbitPrefix + &quot;.republishToDlq&quot;, true);</span><br><span class="line">                map.put(rabbitPrefix + &quot;.deadLetterQueueName&quot;, getErrorQueueName());</span><br><span class="line">                // 如果注解上声明了 isDelayedExchange 为 true，则加上对应的配置</span><br><span class="line">                if (Optional.ofNullable(destination).map(Destination::isDelayedExchange).orElse(false)) &#123;</span><br><span class="line">                    map.put(rabbitPrefix + &quot;.delayedExchange&quot;, true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else if (output != null) &#123;</span><br><span class="line">                // 设置 output 的内容</span><br><span class="line">                if (StringUtils.isEmpty(destinationName)) &#123;</span><br><span class="line">                    destinationName = output.value();</span><br><span class="line">                &#125;</span><br><span class="line">                String name = BindingBeanDefinitionRegistryUtils</span><br><span class="line">                    .getBindingTargetName(output, method);</span><br><span class="line">                BindingProperties properties = bindingServiceProperties.getBindingProperties(name);</span><br><span class="line">                properties.setDestination(destinationName);</span><br><span class="line"></span><br><span class="line">                String rabbitPrefix = RABBIT_PREFIX + name + &quot;.producer&quot;;</span><br><span class="line">                // 如果注解上声明了 isDelayedExchange 为 true，则加上对应的配置</span><br><span class="line">                if (Optional.ofNullable(destination).map(Destination::isDelayedExchange).orElse(false)) &#123;</span><br><span class="line">                    map.put(rabbitPrefix + &quot;.delayedExchange&quot;, true);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private String getApplicationName() &#123;</span><br><span class="line">        return environment.getProperty(&quot;spring.application.name&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义 DLQ 的名称</span><br><span class="line">    public String getErrorQueueName() &#123;</span><br><span class="line">        return getPureServiceName() + &quot;-error.dlq&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 这里由于我们自己的服务通常起名 creams-xxx-service, 所以会做一次去头去尾的操作，你可以自定义</span><br><span class="line">    private String getPureServiceName() &#123;</span><br><span class="line">        String[] names = getApplicationName().split(&quot;-&quot;);</span><br><span class="line">        List&lt;String&gt; nameList = new ArrayList&lt;&gt;(Arrays.asList(names));</span><br><span class="line">        if (nameList.size() &gt;= 3) &#123;</span><br><span class="line">            nameList.remove(0);</span><br><span class="line">            nameList.remove(nameList.size() - 1);</span><br><span class="line">        &#125;</span><br><span class="line">        return String.join(&quot;-&quot;, nameList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 添加或者替换 KV</span><br><span class="line">    private void addOrReplace(MutablePropertySources propertySources,</span><br><span class="line">                              Map&lt;String, Object&gt; map) &#123;</span><br><span class="line"></span><br><span class="line">        MapPropertySource target = null;</span><br><span class="line">        if (propertySources.contains(PROPERTY_SOURCE_NAME)) &#123;</span><br><span class="line">            PropertySource&lt;?&gt; source = propertySources.get(PROPERTY_SOURCE_NAME);</span><br><span class="line">            if (source instanceof MapPropertySource) &#123;</span><br><span class="line">                target = (MapPropertySource) source;</span><br><span class="line">                for (String key : map.keySet()) &#123;</span><br><span class="line">                    if (!target.containsProperty(key)) &#123;</span><br><span class="line">                        target.getSource().put(key, map.get(key));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        if (target == null) &#123;</span><br><span class="line">            target = new MapPropertySource(PROPERTY_SOURCE_NAME, map);</span><br><span class="line">        &#125;</span><br><span class="line">        if (!propertySources.contains(PROPERTY_SOURCE_NAME)) &#123;</span><br><span class="line">            propertySources.addLast(target);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 提供一个注解，用于自定义一些内容</span><br><span class="line">@Target(&#123; ElementType.FIELD, ElementType.METHOD, ElementType.ANNOTATION_TYPE,</span><br><span class="line">    ElementType.PARAMETER &#125;)</span><br><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Inherited</span><br><span class="line">@Documented</span><br><span class="line">public @interface Destination &#123;</span><br><span class="line"></span><br><span class="line">    @AliasFor(&quot;destination&quot;)</span><br><span class="line">    String value() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    @AliasFor(&quot;value&quot;)</span><br><span class="line">    String destination() default &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    boolean isDelayedExchange() default false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="延迟消息的实现"><a href="#延迟消息的实现" class="headerlink" title="延迟消息的实现"></a>延迟消息的实现</h3><p>这里我以实现一个小 Demo 来展示所要实现的东西，这个 Demo 实现发送延迟消息，并自我接收后消费消息。为了节省篇幅，这里略去 Demo 工程的建立以及配置过程，文末将附上地址。</p>
<ul>
<li>建立输入输出的 <code>interface</code> ：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public interface BindingChannelOutput &#123;</span><br><span class="line"></span><br><span class="line">    String DEMO_EVENTS = &quot;demo-events&quot;;</span><br><span class="line"></span><br><span class="line">    @Output(DEMO_EVENTS)</span><br><span class="line">    @Destination(isDelayedExchange = true)</span><br><span class="line">    MessageChannel contract();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public interface BindingChannelInput &#123;</span><br><span class="line"></span><br><span class="line">    String DEMO_INPUTS = &quot;demo-events&quot;;</span><br><span class="line"></span><br><span class="line">    @Input(DEMO_INPUTS)</span><br><span class="line">    @Destination(isDelayedExchange = true)</span><br><span class="line">    SubscribableChannel input();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意这里和一般的 <code>Stream</code> 例子 有一些不一样， 用到了我们之前优化的注解，<code>isDelayedExchange</code> 可以指定为 <code>delay exchange</code>。</p>
<ul>
<li>再建立一个 <code>publisher</code> 用于发送消息，以及一个 <code>Listener</code> 用于接收消息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">@Slf4j</span><br><span class="line">public class Publisher &#123;</span><br><span class="line"></span><br><span class="line">    private final BindingChannelOutput outputChannel;</span><br><span class="line"></span><br><span class="line">    public void send(String content, Long delayMillSeconds) &#123;</span><br><span class="line"></span><br><span class="line">        MessageBuilder&lt;String&gt; builder = MessageBuilder.withPayload(content);</span><br><span class="line">        if (delayMillSeconds &gt; 0) &#123;</span><br><span class="line">            builder.setHeader(&quot;x-delay&quot;, delayMillSeconds);</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(MessageFormat.format(&quot;pushing message [&#123;0&#125;] to remote&quot;, content));</span><br><span class="line">        outputChannel.output().send(builder.build());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class Listener &#123;</span><br><span class="line"></span><br><span class="line">    @StreamListener(BindingChannelInput.DEMO_INPUTS)</span><br><span class="line">    public void update(@Payload String test) &#123;</span><br><span class="line">        // 发通知/邮件/短信</span><br><span class="line">        log.info(MessageFormat.format(&quot;received message [&#123;0&#125;]&quot;, test));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动工程后在 <code>RabbitMQ</code> 的控制台应该可以看到两个 <code>queue</code> ，一个是 <code>demo-events.demo-service</code> 另一个是 <code>demo-service-error.dlq</code> ，这说明我们的配置优化生效了。</p>
<ul>
<li>写一个接口来测试延迟消息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@AllArgsConstructor</span><br><span class="line">public class TestController &#123;</span><br><span class="line">    </span><br><span class="line">    private Publisher publisher;</span><br><span class="line">    </span><br><span class="line">    @PostMapping(&quot;/test&quot;)</span><br><span class="line">    public void test(@RequestParam(&quot;content&quot;) String content) &#123;</span><br><span class="line">        </span><br><span class="line">        publisher.send(content, 20000L);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在控制台可以看到打印时间相差 20s</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2020-03-10 17:17:40.691  INFO 77487 --- [nio-8080-exec-5] com.example.demo.Publisher               : pushing message [&quot;测试&quot;] to remote</span><br><span class="line">2020-03-10 17:18:00.483  INFO 77487 --- [.demo-service-1] com.example.demo.Listener                : received message [&quot;测试&quot;]</span><br></pre></td></tr></table></figure>

<p>至此延迟消息的实现就完成了，具体到业务的话，都是在消费端进行，比如做一些邮件/短信发送或者通知之类的。</p>
<h2 id="问题-amp-思考"><a href="#问题-amp-思考" class="headerlink" title="问题&amp;思考"></a>问题&amp;思考</h2><h3 id="发出去的消息不可查询"><a href="#发出去的消息不可查询" class="headerlink" title="发出去的消息不可查询"></a>发出去的消息不可查询</h3><p>当我们的业务服务向 <code>RabbitMQ</code> 发送消息后，<code>RabbitMQ</code> 在没有到时间的时候是看不到的，那么要保证可靠，就需要在业务服务中记录是否投递到 <code>RabbitMQ</code>，可以参考可靠消息的投递，在本地做记录。</p>
<h3 id="延迟时间的限制"><a href="#延迟时间的限制" class="headerlink" title="延迟时间的限制"></a>延迟时间的限制</h3><p>文档中提到过延迟的最大毫秒数是 2^32-1 ，大概是 49 天多一点，不过一般也不会往 <code>RabbitMQ</code> 堆这么长时间的消息。一般如果是 1-2 天内需要推送/发通知的业务，我们会直接丢给 <code>RabbitMQ</code>，剩下的比如定了一个一年后的提醒之类的业务，都采用在夜间流量少的时候去查一下第二天需要发送的内容，然后丢到 <code>RabbitMQ</code> 来完成。所以定时之类的操作根据业务的具体情况可能还会存在，但是会大大减少。</p>
<h3 id="禁用插件后所有的未发布的消息会丢失"><a href="#禁用插件后所有的未发布的消息会丢失" class="headerlink" title="禁用插件后所有的未发布的消息会丢失"></a>禁用插件后所有的未发布的消息会丢失</h3><p>这个其实还好，一般不会去做这样的操作。</p>
<h3 id="delay-exchange-的路由类型"><a href="#delay-exchange-的路由类型" class="headerlink" title="delay exchange 的路由类型"></a>delay exchange 的路由类型</h3><p>路由类型还是取决于 exchange 本身的类型，由于 <code>Spring Cloud Stream</code> 默认都是 topic 类型，所以这里保持一致。</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/14/服务优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/14/服务优化/" class="post-title-link" itemprop="url">Event Sourcing 和 CQRS落地（八）：服务优化</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-14 10:16:42" itemprop="dateCreated datePublished" datetime="2019-06-14T10:16:42+08:00">2019-06-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 14:55:59" itemprop="dateModified" datetime="2019-06-28T14:55:59+08:00">2019-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/06/14/服务优化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/14/服务优化/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/06/14/服务优化/" class="leancloud_visitors" data-flag-title="Event Sourcing 和 CQRS落地（八）：服务优化">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="服务优化"><a href="#服务优化" class="headerlink" title="服务优化"></a>服务优化</h2><h3 id="失败消息的补偿机制"><a href="#失败消息的补偿机制" class="headerlink" title="失败消息的补偿机制"></a>失败消息的补偿机制</h3><p>由于消息存在发送失败的情况，比如 broker 临时下线或者不可用了，尽管这种情况很少，我们最好做一个机制可以定期或者手动检查，并且尝试自己发送，这里我们就来实现这个机制。</p>
<h4 id="提供未发送的-event-查询"><a href="#提供未发送的-event-查询" class="headerlink" title="提供未发送的 event 查询"></a>提供未发送的 event 查询</h4><ol>
<li>在<code>CustomDomainEventEntryRepository</code>中加入：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查找未发送的事件</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pageable</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Page&lt;CustomDomainEventEntry&gt; <span class="title">findBySentFalse</span><span class="params">(Pageable pageable)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询未发送事件的数量</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">Long <span class="title">countBySentFalse</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将未发送事件的数量集成到 <code>actuator</code>，让我们可以事实看到失败消息的数量：</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventHealthContributor</span> <span class="keyword">implements</span> <span class="title">InfoContributor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CustomDomainEventEntryRepository customDomainEventEntryRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contribute</span><span class="params">(Info.Builder builder)</span> </span>&#123;</span><br><span class="line">        Long count = customDomainEventEntryRepository.countBySentFalse();</span><br><span class="line"></span><br><span class="line">        builder.withDetail(<span class="string">"failedMessage"</span>, count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打开 <code>http://localhost:8080/actuator/info</code> 应该就可以看到我们的失败消息数量。</p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/06/14/服务优化/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/13/Spring-Cloud-Stream-优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/13/Spring-Cloud-Stream-优化/" class="post-title-link" itemprop="url">Event Sourcing 和 CQRS落地（七）：Spring-Cloud-Stream 优化</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-13 15:46:21" itemprop="dateCreated datePublished" datetime="2019-06-13T15:46:21+08:00">2019-06-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 15:18:18" itemprop="dateModified" datetime="2019-06-28T15:18:18+08:00">2019-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/06/13/Spring-Cloud-Stream-优化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/13/Spring-Cloud-Stream-优化/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/06/13/Spring-Cloud-Stream-优化/" class="leancloud_visitors" data-flag-title="Event Sourcing 和 CQRS落地（七）：Spring-Cloud-Stream 优化">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="Spring-Cloud-Stream-优化"><a href="#Spring-Cloud-Stream-优化" class="headerlink" title="Spring Cloud Stream 优化"></a>Spring Cloud Stream 优化</h2><h3 id="有哪些问题"><a href="#有哪些问题" class="headerlink" title="有哪些问题"></a>有哪些问题</h3><p><code>Spring Cloud Stream</code>（以下简称 SCS ）是 Spring Cloud 提供的消息中间件的抽象，但是目前也就支持 kafka 和 rabbitmq，这篇文章主要会讨论一下如何让 SCS 更好的服务我们之前搭建的 Event Sourcing、CQRS 模型。以下是我在使用 SCS 的过程中存在的一些问题：</p>
<ol>
<li><code>StreamListener</code>用来做事件路由分发并不是很理想，SPEL 可能会写的很长（我尝试过用自定义注解代替原生的注解，从而达到简化的目的，但是会出现一些莫名其妙的事件混乱）。</li>
<li>如果配合之前的模型使用，我们需要保证消息的顺序消费，每个方法都需要去 check 事件的当前 seq，很不方便。</li>
<li>在没有 handler 处理某个 type 的事件时，框架会给出一个 warn，然而这个事件可能在 consumer 这里根本不关心。
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/06/13/Spring-Cloud-Stream-优化/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </li></ol></div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/13/实现可靠消息/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/13/实现可靠消息/" class="post-title-link" itemprop="url">Event Sourcing 和 CQRS落地（六）：实现可靠消息</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-13 11:15:44" itemprop="dateCreated datePublished" datetime="2019-06-13T11:15:44+08:00">2019-06-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 15:18:10" itemprop="dateModified" datetime="2019-06-28T15:18:10+08:00">2019-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/06/13/实现可靠消息/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/13/实现可靠消息/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/06/13/实现可靠消息/" class="leancloud_visitors" data-flag-title="Event Sourcing 和 CQRS落地（六）：实现可靠消息">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="实现可靠消息"><a href="#实现可靠消息" class="headerlink" title="实现可靠消息"></a>实现可靠消息</h2><h3 id="什么是可靠消息"><a href="#什么是可靠消息" class="headerlink" title="什么是可靠消息"></a>什么是可靠消息</h3><p>微服务盛行的时代下，消息成为了不可缺少的组件，首先我们看一个例子，contract 系统创建了一个合同，然后发送创建合同的消息。看似简单，实际上分析一下它的出错可能性，会有以下几种：</p>
<ol>
<li>创建合同成功，发送消息失败；</li>
<li>创建合同失败，发送消息成功；</li>
<li>创建合同成功，发送消息成功；</li>
<li>创建合同失败，发送消息失败；</li>
</ol>
<p>同时成功或者同时失败，这个情况是一致的，是正确的，我们需要关心的就是不一致的情况。那么最简单的办法，就是让创建合同和发送消息成为一个事务，要么一起成功，要么一起失败，但是这么做的话耦合性太强，本身合同创建成功了，却因为消息发送的失败强制回滚。这个时候，可能就想到了存储消息数据，将合同创建和消息数据的存储作为一个事务，消息发送成功之后再去删除消息数据，定期去扫描未发送的消息数据，来保证消息的发送。但是这么做还是有一定的代价的，需要实现消息的存储，消息存储和合同创建还是耦合在一起的，不过这样的模式到 <code>Event Sourcing</code> 下面那就比较理想了，因为本身消息数据和 event 是一样的，存储了 event 相当于完成了存储消息数据，只需要在 event 下做一个标记即可。</p>
<p>做完了上面这些，就能保证消息一定从 producer 到 broker 这一过程，当然要做到消息不丢，必然产生的结果就是消息可能会重复，情况就是 broker 收到了消息，但是没有通知到 producer，这种情况下 producer 是认为消息没有投递成功的，会出现重复投递的情况。保证了消息一定送达 broker 之后，就是 consumer 和 broker 的关系了，consumer 在消费之后需要告诉 broker 消费成功，否则 broker 需要一直保存这些消息。当然消费端可能需要做更多的事情，比如保证同一 aggregate 事件的顺序消费。下面文章会以在 Axon 框架上做一些拓展，以分别实现 consumer 和 producer。</p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/06/13/实现可靠消息/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/12/深入使用-Axon/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/12/深入使用-Axon/" class="post-title-link" itemprop="url">Event Sourcing 和 CQRS落地（五）：深入使用-Axon</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-12 15:10:09" itemprop="dateCreated datePublished" datetime="2019-06-12T15:10:09+08:00">2019-06-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 14:48:46" itemprop="dateModified" datetime="2019-06-28T14:48:46+08:00">2019-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/06/12/深入使用-Axon/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/12/深入使用-Axon/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/06/12/深入使用-Axon/" class="leancloud_visitors" data-flag-title="Event Sourcing 和 CQRS落地（五）：深入使用-Axon">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="深入使用-Axon"><a href="#深入使用-Axon" class="headerlink" title="深入使用 Axon"></a>深入使用 Axon</h2><h3 id="实现-snapshot"><a href="#实现-snapshot" class="headerlink" title="实现 snapshot"></a>实现 snapshot</h3><p>在前面文章中，我们略微涉及了一些 snapshot 的概念，其实这个概念还是比较好理解的，当事件堆积到一定的程度，每次 load 都会花费一定的时间，这个时候自然会想到 snapshot，先将一部分事件进行计算，然后生成一个 snapshot，后续 load 的时候先读取 snapshot，这样就省去了很多计算过程。如果你读过之前改写 event store 部分的代码，就会发现每个 aggregate 实际上只会存储一个 snapshot，每当新的生成的时候会替换老的。对一个 aggregate 来说，snapshot 同样和事件差不多，它都可以当做事件来处理，但是对于 aggregate 来说，我并不想去处理 snapshot，我只是需要一个计算好的结果而已。基于这个，Axon 给我们提供了 <code>AggregateSnapshotter</code>，这类 snapshot 可以直接还原 aggregate 状态。</p>
<p>了解大概的原理之后，我们就要做的事情其实比较明确了：</p>
<ol>
<li>告诉 Axon 我们要在什么时候触发 snapshot 的生成。</li>
<li>告诉 Axon 我们要生成什么样的 snapshot。
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/06/12/深入使用-Axon/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </li></ol></div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/11/实现-CQRS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/11/实现-CQRS/" class="post-title-link" itemprop="url">Event Sourcing 和 CQRS落地（四）：CQRS 实现</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-11 22:39:54" itemprop="dateCreated datePublished" datetime="2019-06-11T22:39:54+08:00">2019-06-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 15:06:38" itemprop="dateModified" datetime="2019-06-28T15:06:38+08:00">2019-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/06/11/实现-CQRS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/11/实现-CQRS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/06/11/实现-CQRS/" class="leancloud_visitors" data-flag-title="Event Sourcing 和 CQRS落地（四）：CQRS 实现">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="实现-CQRS"><a href="#实现-CQRS" class="headerlink" title="实现 CQRS"></a>实现 CQRS</h2><p>在实现了 EventSoucing 之后，亟待解决的问题是查询了，理论上同一 Service 可以做到多数据源，甚至多数据库，这篇文章就暂时以同一个数据库为例子，同样使用 JPA 去做 view 的 ORM。</p>
<h3 id="建立-entity"><a href="#建立-entity" class="headerlink" title="建立 entity"></a>建立 entity</h3><p>第一步当然是建立对应的 Entity 和对应的 Repository 了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContractView</span> <span class="keyword">implements</span> <span class="title">ContractInterface</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@Column</span>(length = <span class="number">64</span>)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String partyA;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String partyB;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> deleted = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ContractViewRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">ContractView</span>, <span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/06/11/实现-CQRS/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/11/实现-Event-Sourcing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/11/实现-Event-Sourcing/" class="post-title-link" itemprop="url">Event Sourcing 和 CQRS落地（三）：Event-Sourcing 实现</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-11 11:07:57" itemprop="dateCreated datePublished" datetime="2019-06-11T11:07:57+08:00">2019-06-11</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 15:06:24" itemprop="dateModified" datetime="2019-06-28T15:06:24+08:00">2019-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/06/11/实现-Event-Sourcing/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/11/实现-Event-Sourcing/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/06/11/实现-Event-Sourcing/" class="leancloud_visitors" data-flag-title="Event Sourcing 和 CQRS落地（三）：Event-Sourcing 实现">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="实现-Event-Soucing"><a href="#实现-Event-Soucing" class="headerlink" title="实现 Event Soucing"></a>实现 Event Soucing</h2><p>在了解了相关的基础之后，这里会以最简单的方式实现一个 <code>EventSourcing</code> 的例子，然后逐渐在之后的过程去丰富，本篇内容会实现一个将增删改操作使用 EventSoucing 取代的例子，读取部分暂时不做涉及。</p>
<h3 id="Spring-Boot-工程搭建"><a href="#Spring-Boot-工程搭建" class="headerlink" title="Spring Boot 工程搭建"></a>Spring Boot 工程搭建</h3><p>打开 <a href="http://start.spring.io/" target="_blank" rel="noopener">http://start.spring.io/</a> 选择对应的版本(这里是 2.1.5 )以及相应的依赖，这里多选了一些之后会用到的服务：</p>
<p><img src="https://note.youdao.com/yws/api/personal/file/WEB07deaa43972f6f1bc5c35c18db67884f?method=download&shareKey=afca0c0ceb799824f9cb44104275cb6f" alt="image"></p>
<p>添加配置文件: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">event-sourcing-service</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql://localhost:3306/event?useUnicode=true&amp;autoReconnect=true&amp;rewriteBatchedStatements=TRUE</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  jpa:</span></span><br><span class="line"><span class="attr">    hibernate:</span></span><br><span class="line"><span class="attr">      ddl-auto:</span> <span class="string">update</span></span><br><span class="line"><span class="attr">      use-new-id-generator-mappings:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    show-sql:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line">      <span class="string">hibernate.dialect:</span> <span class="string">org.hibernate.dialect.MySQL55Dialect</span></span><br></pre></td></tr></table></figure>

<p>为了便于测试，这里我开启了 JPA 的自动更新，开发中你可能会使用 flyway 或者其他工具来管理数据库 schema 以及数据迁移。至此一个简单的服务就搭建完毕了。</p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/06/11/实现-Event-Sourcing/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/10/UID-Generator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/10/UID-Generator/" class="post-title-link" itemprop="url">Event Sourcing 和 CQRS落地（二）：UID-Generator 实现</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-10 21:07:40" itemprop="dateCreated datePublished" datetime="2019-06-10T21:07:40+08:00">2019-06-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 14:48:02" itemprop="dateModified" datetime="2019-06-28T14:48:02+08:00">2019-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/06/10/UID-Generator/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/10/UID-Generator/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/06/10/UID-Generator/" class="leancloud_visitors" data-flag-title="Event Sourcing 和 CQRS落地（二）：UID-Generator 实现">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="UID-Generator"><a href="#UID-Generator" class="headerlink" title="UID Generator"></a>UID Generator</h2><h3 id="为什么要使用"><a href="#为什么要使用" class="headerlink" title="为什么要使用"></a>为什么要使用</h3><p>由于 Event Soucing 是记录事件的，那么 Object Id 肯定就不能是用数据库生成的了，基本上所有的 Event Soucing 相关的框架都是将事件直接序列化，然后对应到 Object，所以这种情况下，就需要自己产生 ID，而自己生成 ID 的话，就有很多限制，比如需要根据时间递增，尽量比较短，在分布式的情况下 ID 保证不能重复等等，本文会比较几种方案，然后选择一种比较好的来实现。</p>
<h3 id="方案选择"><a href="#方案选择" class="headerlink" title="方案选择"></a>方案选择</h3><h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p>这种方案其实就是基于数据库的自增 ID，各个分布式系统通过一个数据库去分配 ID，由于依赖了数据库，性能肯定是个问题，如果部署多点数据库，不但实现麻烦，而且性能还是取决于数据库数量，所以在分布式系统当中，并发量大的系统一般不会采取该方案。</p>
<h4 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h4><p>UUID是通用唯一识别码 (Universally Unique Identifier)，是由一组 32 位数的 16 进制数字所构成，也就是 128 bit。在规范字符串格式中，UUID 的十六个八位字节被表示为 32个十六进制（基数16）数字，以连字号分隔的五组来显示，形式为 8-4-4-4-12，总共有 36个字符（即三十二个英数字母和四个连字号）。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">123e4567-e89b-12d3-a456-426655440000</span><br><span class="line">xxxxxxxx-xxxx-Mxxx-Nxxx-xxxxxxxxxxxx</span><br></pre></td></tr></table></figure>

<p>N那个位置，只会是8,9,a,b， M那个位置，代表版本号，由于UUID的标准实现有5个版本，所以只会是1,2,3,4,5。不同的版本基于的算法不一样，而在 Java 中最常用的 <code>UUID.randomUUID()</code> 是基于版本 4 的，基于随机数，也会有重复的概率，只是概率特别低，低到几乎可以忽略而已。</p>
<p>由于这种算法生成的 ID 是字符串，而且长度有特别的长，非常不利于建立索引等操作，所以通常不会用来作为主键。</p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/06/10/UID-Generator/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/10/Event-Sourcing-And-CQRS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/10/Event-Sourcing-And-CQRS/" class="post-title-link" itemprop="url">Event Sourcing 和 CQRS落地（一）：前言</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-06-10 15:21:30" itemprop="dateCreated datePublished" datetime="2019-06-10T15:21:30+08:00">2019-06-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-28 15:22:13" itemprop="dateModified" datetime="2019-06-28T15:22:13+08:00">2019-06-28</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/后端/" itemprop="url" rel="index"><span itemprop="name">后端</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2019/06/10/Event-Sourcing-And-CQRS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2019/06/10/Event-Sourcing-And-CQRS/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2019/06/10/Event-Sourcing-And-CQRS/" class="leancloud_visitors" data-flag-title="Event Sourcing 和 CQRS落地（一）：前言">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Event-Sourcing-And-CQRS"><a href="#Event-Sourcing-And-CQRS" class="headerlink" title="Event Sourcing And CQRS"></a>Event Sourcing And CQRS</h2><h3 id="Event-Sourcing-、CQRS-简述"><a href="#Event-Sourcing-、CQRS-简述" class="headerlink" title="Event Sourcing 、CQRS 简述"></a>Event Sourcing 、CQRS 简述</h3><p>Event Sourcing 简单来说就是记录对象的每个事件而不是记录对象的最新状态，比如新建、修改等，只记录事件内容，当需要最新的状态的时，通过堆叠事件将最新的状态计算出来。那么这种模式查询的时候性能会变的非常差，这个时候就涉及到了 CQRS ，简单的理解就是读写分离，通过事件触发，将最新状态保存到读库，查询全都走读库，理论上代码层，数据库层，都可以做到分离，当然也可以不分离，一般来说为了保证数据库性能，这里起码会将数据库分离。</p>
<h3 id="为什么要使用"><a href="#为什么要使用" class="headerlink" title="为什么要使用"></a>为什么要使用</h3><p>了解了 Event Sourcing 的基本内容之后，我们可以发现这个模式有很多的好处：</p>
<ul>
<li>记录了对象的事件，相当于记录了整个历史，可以查看到任意一个时间点的对象状态；</li>
<li>都是以事件形式进行写入操作，理论上在高并发的情况下，没有死锁，性能会快很多；</li>
<li>可以基于历史事件做更多的数据分析。</li>
</ul>
<p>Event Soucing 通常会和 DDD CQRS 一起讨论，在微服务盛行的前提下，DDD 让整个软件系统松耦合，而 Event Soucing 也是面向 Aggregate，这个模式很符合 DDD 思想，同时由于 Event Soucing 的特性，读取数据必然会成为瓶颈，这个时候 CQRS 就起到做用了，通过读写分离，让各自的职责专一，实际上在传统的方式中我们也可能会这么干，只是方式略微不同，比如有一个只读库，时时同步主库，让查询通过只读库进行，那么如果查询量特别大的时候，起码写库不会因为查询而下降性能。</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>由于我们公司的技术体系基本是 Spring 全家桶，而 Java 界似乎 Axon 又是比较流行的 Event Sourcing 框架，本着对新技术的尝试以及某些业务也确实有这方面的需求的出发点，对 Axon 做了一些尝试。后面的一系列文章将会以 Spring Cloud 作为背景，探讨 Axon 如何使用，以及如何出处理一些常见的业务需求（溯源、读写分离、消息可靠等），所以在看后面的文章之前最好对 Spring Boot、Spring Cloud、Spring Cloud Stream、Spring Data JPA 等有一些基本的了解。</p>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3><ol>
<li><a href="/2019/06/10/Event-Sourcing-And-CQRS/" title="Event Sourcing 和 CQRS落地（一）：前言">Event Sourcing 和 CQRS落地（一）：前言</a></li>
<li><a href="/2019/06/10/UID-Generator/" title="Event Sourcing 和 CQRS落地（二）：UID-Generator 实现">Event Sourcing 和 CQRS落地（二）：UID-Generator 实现</a></li>
<li><a href="/2019/06/11/实现-Event-Sourcing/" title="Event Sourcing 和 CQRS落地（三）：Event-Sourcing 实现">Event Sourcing 和 CQRS落地（三）：Event-Sourcing 实现</a></li>
<li><a href="/2019/06/11/实现-CQRS/" title="Event Sourcing 和 CQRS落地（四）：CQRS 实现">Event Sourcing 和 CQRS落地（四）：CQRS 实现</a></li>
<li><a href="/2019/06/12/深入使用-Axon/" title="Event Sourcing 和 CQRS落地（五）：深入使用-Axon">Event Sourcing 和 CQRS落地（五）：深入使用-Axon</a></li>
<li><a href="/2019/06/13/实现可靠消息/" title="Event Sourcing 和 CQRS落地（六）：实现可靠消息">Event Sourcing 和 CQRS落地（六）：实现可靠消息</a></li>
<li><a href="/2019/06/13/Spring-Cloud-Stream-优化/" title="Event Sourcing 和 CQRS落地（七）：Spring-Cloud-Stream 优化">Event Sourcing 和 CQRS落地（七）：Spring-Cloud-Stream 优化</a>he</li>
<li><a href="/2019/06/14/服务优化/" title="Event Sourcing 和 CQRS落地（八）：服务优化">Event Sourcing 和 CQRS落地（八）：服务优化</a>

</li>
</ol>
<p><a href="https://github.com/soooban/AxonDemo" target="_blank" rel="noopener">最终例子</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/02/26/Hexo的介绍以及使用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jokefaker">
      <meta itemprop="description" content="记录小伙伴们的分享">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CREAMS 小组">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2016/02/26/Hexo的介绍以及使用/" class="post-title-link" itemprop="url">Hexo的介绍以及使用</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2016-02-26 10:12:20" itemprop="dateCreated datePublished" datetime="2016-02-26T10:12:20+08:00">2016-02-26</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2019-06-14 09:54:09" itemprop="dateModified" datetime="2019-06-14T09:54:09+08:00">2019-06-14</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/其他/" itemprop="url" rel="index"><span itemprop="name">其他</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/2016/02/26/Hexo的介绍以及使用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/2016/02/26/Hexo的介绍以及使用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/2016/02/26/Hexo的介绍以及使用/" class="leancloud_visitors" data-flag-title="Hexo的介绍以及使用">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>hexo是一个基于Node.js的静态博客程序，其编译上百篇文字只需要几秒。hexo生成的静态网页可以直接放到GitHub Pages，BAE，SAE等平台上。基于Github Pages的博客系统还是很流行的，所以我打算将我们以后所有的session全都放到这个平台上面，这样对内有一个记录，以后新人进来可以查阅，对外也有一定的输出，如果以后质量上去了，还是有希望做到有一定的影响力的。关于session大家可以放开了讲，也可以并不完全是技术方面的，只要是分享即可:]。</p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h3><p>开发人员应该对Node比较熟悉了，就算不熟悉或多或少也是听到过的，没听到过的也没关系，到<a href="https://nodejs.org/en/" target="_blank" rel="noopener">Node官网</a>下载最新的版本安装即可。</p>
<h3 id="Git"><a href="#Git" class="headerlink" title="Git"></a>Git</h3><p>同样要使用hexo需要安装Git，相信大部分也都已经安装了，如果你从来没了解过Git，建议去<a href="https://git-scm.com/" target="_blank" rel="noopener">Git官网</a>下载安装最新版本，同时使用谷歌搜索引擎简单的了解一下Git的使用:]。</p>
<h3 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h3><p><a href="https://github.com/" target="_blank" rel="noopener">Github</a>是一个非常好的地方，不管是设计狮、攻城狮、产品狗都可以去了解一下，上面有很多值得学习或者阅读的东西。前面说了hexo是可以将静态文件放多很多的平台上的，我们这里就使用比较流行的Github Pages，所以最起码你得有个账号。</p>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2016/02/26/Hexo的介绍以及使用/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jokefaker</p>
              <div class="site-description motion-element" itemprop="description">记录小伙伴们的分享</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">5</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jokefaker</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.1.2</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.2"></script>



  

  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  
  

<script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script>



<script src="//unpkg.com/valine/dist/Valine.min.js"></script>

<script>
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(function(item) {
    return GUEST.indexOf(item) > -1;
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: '4UJvWpBJzhy0W44yVReXIJtm-gzGzoHsz',
    appKey: 'HuVN5rFpsHYBLCTyfdE4GxzB',
    placeholder: 'Just go go',
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: true,
    lang: 'zh-cn' || 'zh-cn'
  });
</script>





  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
