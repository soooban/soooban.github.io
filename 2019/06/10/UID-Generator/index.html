<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>UID Generator | 搜办小组</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="UID Generator为什么要使用由于 Event Soucing 是记录事件的，那么 Object Id 肯定就不能是用数据库生成的了，基本上所有的 Event Soucing 相关的框架都是将事件直接序列化，然后对应到 Object，所以这种情况下，就需要自己产生 ID，而自己生成 ID 的话，就有很多限制，比如需要根据时间递增，尽量比较短，在分布式的情况下 ID 保证不能重复等等，本文会">
<meta property="og:type" content="article">
<meta property="og:title" content="UID Generator">
<meta property="og:url" content="http://yoursite.com/2019/06/10/UID-Generator/index.html">
<meta property="og:site_name" content="搜办小组">
<meta property="og:description" content="UID Generator为什么要使用由于 Event Soucing 是记录事件的，那么 Object Id 肯定就不能是用数据库生成的了，基本上所有的 Event Soucing 相关的框架都是将事件直接序列化，然后对应到 Object，所以这种情况下，就需要自己产生 ID，而自己生成 ID 的话，就有很多限制，比如需要根据时间递增，尽量比较短，在分布式的情况下 ID 保证不能重复等等，本文会">
<meta property="og:updated_time" content="2019-06-10T13:08:04.906Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="UID Generator">
<meta name="twitter:description" content="UID Generator为什么要使用由于 Event Soucing 是记录事件的，那么 Object Id 肯定就不能是用数据库生成的了，基本上所有的 Event Soucing 相关的框架都是将事件直接序列化，然后对应到 Object，所以这种情况下，就需要自己产生 ID，而自己生成 ID 的话，就有很多限制，比如需要根据时间递增，尽量比较短，在分布式的情况下 ID 保证不能重复等等，本文会">
  
    <link rel="alternate" href="/atom.xml" title="搜办小组" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">搜办小组</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-UID-Generator" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/10/UID-Generator/" class="article-date">
  <time datetime="2019-06-10T13:07:40.000Z" itemprop="datePublished">2019-06-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      UID Generator
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="UID-Generator"><a href="#UID-Generator" class="headerlink" title="UID Generator"></a>UID Generator</h2><h3 id="为什么要使用"><a href="#为什么要使用" class="headerlink" title="为什么要使用"></a>为什么要使用</h3><p>由于 Event Soucing 是记录事件的，那么 Object Id 肯定就不能是用数据库生成的了，基本上所有的 Event Soucing 相关的框架都是将事件直接序列化，然后对应到 Object，所以这种情况下，就需要自己产生 ID，而自己生成 ID 的话，就有很多限制，比如需要根据时间递增，尽量比较短，在分布式的情况下 ID 保证不能重复等等，本文会比较几种方案，然后选择一种比较好的来实现。</p>
<h3 id="方案选择"><a href="#方案选择" class="headerlink" title="方案选择"></a>方案选择</h3><h4 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h4><p>这种方案其实就是基于数据库的自增 ID，各个分布式系统通过一个数据库去分配 ID，由于依赖了数据库，性能肯定是个问题，如果部署多点数据库，不但实现麻烦，而且性能还是取决于数据库数量，所以在分布式系统当中，并发量大的系统一般不会采取该方案。</p>
<h4 id="UUID"><a href="#UUID" class="headerlink" title="UUID"></a>UUID</h4><p>UUID是通用唯一识别码 (Universally Unique Identifier)，是由一组 32 位数的 16 进制数字所构成，也就是 128 bit。在规范字符串格式中，UUID 的十六个八位字节被表示为 32个十六进制（基数16）数字，以连字号分隔的五组来显示，形式为 8-4-4-4-12，总共有 36个字符（即三十二个英数字母和四个连字号）。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">123e4567-e89b-12d3-a456-426655440000&#10;xxxxxxxx-xxxx-Mxxx-Nxxx-xxxxxxxxxxxx</span><br></pre></td></tr></table></figure>
<p>N那个位置，只会是8,9,a,b， M那个位置，代表版本号，由于UUID的标准实现有5个版本，所以只会是1,2,3,4,5。不同的版本基于的算法不一样，而在 Java 中最常用的 <figure class="highlight"><figcaption><span>是基于版本 4 的，基于随机数，也会有重复的概率，只是概率特别低，低到几乎可以忽略而已。</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#30001;&#20110;&#36825;&#31181;&#31639;&#27861;&#29983;&#25104;&#30340; ID &#26159;&#23383;&#31526;&#20018;&#65292;&#32780;&#19988;&#38271;&#24230;&#26377;&#29305;&#21035;&#30340;&#38271;&#65292;&#38750;&#24120;&#19981;&#21033;&#20110;&#24314;&#31435;&#32034;&#24341;&#31561;&#25805;&#20316;&#65292;&#25152;&#20197;&#36890;&#24120;&#19981;&#20250;&#29992;&#26469;&#20316;&#20026;&#20027;&#38190;&#12290;&#10;&#10;#### Snowflake&#10;&#20026;&#20102;&#28385;&#36275;&#22312;&#20998;&#24067;&#24335;&#31995;&#32479;&#20013;&#21487;&#20197;&#29983;&#25104;&#20840;&#23616;&#21807;&#19968;&#19988;&#36235;&#21183;&#36882;&#22686;&#30340; ID&#65292;Twitter &#25512;&#20986;&#20102;&#19968;&#31181;&#31639;&#27861;&#65292;&#35813;&#31639;&#27861;&#30001; 64 bit &#32452;&#25104;&#12290;&#10;&#10;![](https://note.youdao.com/yws/api/personal/file/WEB494d8493f3a2635c4dda26380c3ee06a?method=download&#38;shareKey=ee740e662e59ad62b907200f6c1aac26)&#10;&#10;* &#31532;&#19968;&#20301;&#27704;&#36828;&#26159;0&#65292;&#23454;&#38469;&#19978;&#36825;&#26159;&#20026;&#20102;&#35753;&#29983;&#25104;&#30340; ID &#37117;&#20026;&#27491;&#25968;&#65292;&#20197;&#20445;&#35777;&#36235;&#21183;&#36882;&#22686;&#65307;&#10;* &#21518;&#38754; 41 &#20301;&#29992;&#26469;&#35760;&#24405;&#26102;&#38388;&#65292;&#29702;&#35770;&#19978;&#21487;&#20197;&#35760;&#24405; 2^41 &#27627;&#31186;&#65292;2^41/(24 * 3600 * 365 * 1000) = 69.7 &#24180;&#65292;&#25152;&#20197;&#36825;&#37324;&#30340;&#29702;&#35770;&#26368;&#22823;&#20351;&#29992;&#26102;&#38388;&#23601;&#26159; 70 &#24180;&#24038;&#21491;&#65307;&#10;* &#22312;&#21518;&#38754; 10 &#20301;&#29992;&#26469;&#35760;&#24405;&#26426;&#22120; ID &#65292;&#26356;&#20934;&#30830;&#30340;&#24212;&#35813;&#35828;&#26159;&#23454;&#20363; ID&#65292;&#23545;&#24212;&#30340;&#21487;&#20197;&#26159;&#26576;&#20010; Container &#25110;&#32773;&#26576;&#20010;&#36827;&#31243;&#65292;&#26368;&#22810;&#25903;&#25345; 1024 &#20010;&#65307;&#10;* &#26368;&#21518;12&#20301;&#29992;&#26469;&#35760;&#24405;&#24207;&#21015;&#21495;&#65292;&#26469;&#20445;&#35777;&#27599;&#20010;&#23454;&#20363;&#27599;&#27627;&#31186;&#29983;&#25104;&#30340; ID &#21807;&#19968;&#65307;&#10;&#10;&#35813;&#31639;&#27861;&#30340;&#20248;&#28857;&#65306;&#10;&#10;* &#19981;&#20381;&#36182;&#25968;&#25454;&#24211;&#65292;&#39640;&#24615;&#33021;&#65307;&#10;* &#29983;&#25104;&#30340; ID &#36235;&#21183;&#36882;&#22686;&#65307;&#10;* 64 bit &#30340;&#25968;&#23383;&#20316;&#20026; ID &#30456;&#27604; UUID &#30701;&#30340;&#22810;&#65292;&#26041;&#20415;&#24314;&#31435;&#25968;&#25454;&#24211;&#32034;&#24341;&#12290;&#10;&#10;&#35813;&#31639;&#27861;&#30340;&#32570;&#28857;&#65306;&#10;&#10;* &#20381;&#36182;&#31995;&#32479;&#26102;&#38047;&#65292;&#22914;&#26524;&#31995;&#32479;&#26102;&#38047;&#21457;&#29983;&#22238;&#25320;&#65292;&#37027;&#20040;&#26377;&#21487;&#33021;&#36896;&#25104; ID &#20914;&#31361;&#25110;&#20081;&#24207;&#12290;&#10;&#10;### &#22522;&#20110; Java &#30340;&#23454;&#29616;&#10;&#22522;&#20110;&#19978;&#38754;&#30340;&#20998;&#26512;&#65292;&#36825;&#37324;&#25105;&#20204;&#36873;&#25321;&#20351;&#29992; Snowflake &#26469;&#23454;&#29616;&#65292;Twitter &#23448;&#26041;&#25552;&#20379;&#20102;&#19968;&#20010;[ Scala &#29256;&#26412;&#30340;&#23454;&#29616;](https://github.com/twitter/snowflake/tree/scala_28)&#65292;&#22312;&#36825;&#37324;&#25105;&#20204;&#23454;&#29616;&#19968;&#20010; Java &#29256;&#26412;&#65292;&#20855;&#20307;&#20195;&#30721;&#22914;&#19979;&#65306;</span><br></pre></td></tr></table></figure></p>
<p>@Slf4j<br>public class SnowFlake {</p>
<pre><code>private static class TimeBackwardsException extends RuntimeException {
    public TimeBackwardsException(String message) {
        super(message);
    }
}

/**
 * 起始的时间戳
 */
private static final long START_STAMP = 1262275200000L;

/**
 * 每一部分占用的位数
 */
private static final long SEQUENCE_BIT = 12; //序列号占用的位数
private static final long MACHINE_BIT = 10;   //机器标识占用的位数

/**
 * 每一部分的最大值
 */
private static final long MAX_MACHINE_NUM = -1L ^ (-1L &lt;&lt; MACHINE_BIT);
private static final long MAX_SEQUENCE = -1L ^ (-1L &lt;&lt; SEQUENCE_BIT);

/**
 * 每一部分向左的位移
 */
private static final long MACHINE_LEFT = SEQUENCE_BIT;
private static final long TIMESTAMP_LEFT = SEQUENCE_BIT + MACHINE_BIT;

private long machineId;     //机器标识
private long sequence = 0L; //序列号
private long lastStamp = -1L;//上一次时间戳

public SnowFlake(long machineId) {

    if (machineId &gt; MAX_MACHINE_NUM || machineId &lt; 0) {
        throw new IllegalArgumentException(&quot;machineId can&apos;t be greater than MAX_MACHINE_NUM or less than 0&quot;);
    }
    this.machineId = machineId;
}

/**
 * 产生下一个ID
 */
public synchronized Long nextId() {
    long currStamp = getNewStamp();
    if (currStamp &lt; lastStamp) {
        throw new TimeBackwardsException(&quot;Clock moved backwards.  Refusing to generate id&quot;);
    }

    if (currStamp == lastStamp) {
        sequence = (sequence + 1) &amp; MAX_SEQUENCE;

        //同一毫秒的序列数已经达到最大
        if (sequence == 0L) {
            sequence = new Random().nextInt(10);
            currStamp = getNextMill();
        }
    } else {
        // 新的一毫秒，随机从 0-9 中开始
        sequence = new Random().nextInt(10);
    }
    lastStamp = currStamp;

    return (currStamp - START_STAMP) &lt;&lt; TIMESTAMP_LEFT //时间戳部分
        | machineId &lt;&lt; MACHINE_LEFT             //机器标识部分
        | sequence;                             //序列号部分
}

private long getNextMill() {
    long mill = getNewStamp();
    while (mill &lt;= lastStamp) {
        mill = getNewStamp();
    }

    return mill;
}

private long getNewStamp() {
    return System.currentTimeMillis();
}
</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#20180;&#32454;&#38405;&#35835;&#20197;&#19979;&#36825;&#27573;&#20195;&#30721;&#65292;&#20320;&#20250;&#21457;&#29616;&#26377;&#20010;&#22320;&#26041;&#21644;&#25105;&#20204;&#25551;&#36848;&#30340;&#19981;&#22826;&#19968;&#26679;</span><br></pre></td></tr></table></figure></p>
<pre><code>if (currStamp == lastStamp) {
    sequence = (sequence + 1) &amp; MAX_SEQUENCE;

    //同一毫秒的序列数已经达到最大
    if (sequence == 0L) {
        sequence = new Random().nextInt(10);
        currStamp = getNextMill();
    }
} else {
    // 新的一毫秒，随机从 0-9 中开始
    sequence = new Random().nextInt(10);
}
</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#36825;&#37324;&#20877;&#27627;&#31186;&#21047;&#26032;&#30340;&#26102;&#20505;&#65292;&#25105;&#20204;&#24182;&#27809;&#26377;&#21435;&#25226;&#24207;&#21015;&#21495;&#32622;&#20026; 0&#65292;&#32780;&#26159;&#38543;&#26426;&#20174; 0-9 &#21462;&#20102;&#19968;&#20010;&#25968;&#65292;&#36825;&#20040;&#20570;&#30340;&#21407;&#22240;&#26159;&#22312;&#24182;&#21457;&#37327;&#19981;&#26159;&#29305;&#21035;&#39640;&#30340;&#26102;&#20505;&#65292;&#22914;&#26524;&#37117;&#20174; 0 &#24320;&#22987;&#30340;&#35805;&#65292;&#20250;&#23548;&#33268;&#29983;&#25104;&#30340; ID &#37117;&#26159;&#20598;&#25968;&#65292;&#37027;&#20040;&#22312;&#20570;&#19968;&#20123;&#20998;&#34920;&#25805;&#20316;&#30340;&#26102;&#20505;&#65292;&#20250;&#23548;&#33268;&#20005;&#37325;&#30340;&#20998;&#37197;&#19981;&#22343;&#21248;&#65292;&#25152;&#20197;&#36825;&#37324;&#25105;&#20204;&#38543;&#26426;&#20174; 0-9 &#24320;&#22987;&#35753;&#20135;&#29983;&#30340; ID &#23613;&#21487;&#33021;&#30340;&#20998;&#37197;&#22343;&#21248;&#12290;&#20294;&#26159;&#36825;&#20040;&#20570;&#26159;&#20250;&#19979;&#38477;&#24615;&#33021;&#30340;&#65292;&#27599;&#27627;&#31186;&#30340; ID &#29983;&#25104;&#25968;&#37327;&#20250;&#19979;&#38477;&#19968;&#20123;&#65292;&#20294;&#26159;&#36825;&#24182;&#27809;&#26377;&#19979;&#38477;&#25968;&#37327;&#32423;&#65292;&#23436;&#20840;&#26159;&#21487;&#20197;&#25509;&#21463;&#30340;&#12290;&#10;&#10;### &#22522;&#20110; Spring Cloud &#20998;&#37197; Worker Id&#10;&#10;&#19978;&#38754;&#20171;&#32461;&#20102;&#22914;&#20309;&#20351;&#29992; Snowflake &#26469;&#29983;&#25104; ID&#65292;&#37027;&#20040;&#32467;&#21512; Spring Cloud &#65292;&#25105;&#20204;&#38656;&#35201;&#32473;&#27599;&#20010;&#33410;&#28857;&#20998;&#37197;&#19968;&#20010; Worker ID&#65292;&#20294;&#26159;&#30001;&#20110; Spring Cloud &#30340;&#29305;&#28857;&#65292;&#23427;&#26159;&#24076;&#26395;&#27599;&#20010;&#33410;&#28857;&#26080;&#29366;&#24577;&#21270;&#30340;&#65292;&#36825;&#23601;&#32473;&#25105;&#20204;&#20998;&#37197; Worker ID &#24102;&#26469;&#20102;&#19968;&#23450;&#30340;&#38590;&#24230;&#65292;&#22914;&#26524;&#25105;&#20204;&#38656;&#35201;&#21306;&#20998;&#27599;&#20010;&#20960;&#28857;&#65292;&#23601;&#19981;&#24471;&#19981;&#23558;&#33410;&#28857;&#20449;&#24687;&#23384;&#20648;&#21040;&#26576;&#20010;&#20013;&#22830;&#65292;&#28982;&#21518;&#20877;&#20998;&#37197;&#65292;&#20026;&#20102;&#20415;&#20110;&#20043;&#21518;&#30340;&#27700;&#24179;&#25193;&#23637;&#65292;&#36825;&#37324;&#25105;&#20204;&#22522;&#20110;&#20869;&#37096;&#20195;&#30721;&#23454;&#29616;&#65292;&#22823;&#27010;&#30340;&#21407;&#29702;&#26159;&#22312;&#26381;&#21153;&#21551;&#21160;&#30340;&#26102;&#20505;&#65292;&#35760;&#24405;&#19979;&#33410;&#28857; IP &#21644; MAC &#65292;&#20316;&#20026; Service Node Key &#23384;&#20648;&#21040;&#25968;&#25454;&#24211;&#65292;&#36825;&#20010; Key &#22312;&#25968;&#25454;&#24211;&#20013;&#21807;&#19968;&#65292;&#36890;&#36807;&#36825;&#20010;&#21807;&#19968;&#30340; Key &#32473;&#19981;&#21516;&#30340;&#33410;&#28857;&#20998;&#37197; ID&#12290;&#19979;&#38754;&#25105;&#20204;&#23581;&#35797;&#20351;&#29992; JPA &#26469;&#23454;&#29616;&#36825;&#19968;&#36807;&#31243;&#12290;&#10;&#10;**Spring Cloud &#22312; 2.1.0 &#20043;&#21518;&#25552;&#20379;&#20102; ```getInstanceId()``` &#26041;&#27861;&#65292;&#20294;&#26159;&#21487;&#20197;&#20026;&#31354;&#65292;&#25152;&#20197;&#38656;&#35201;&#30475;&#21508;&#20010;&#20855;&#20307;&#23454;&#29616;&#65292;&#25105;&#30475;&#20102; K8S &#21644; consul &#37117;&#25552;&#20379;&#20102;&#35813;&#26041;&#27861;&#30340;&#23454;&#29616;**</span><br></pre></td></tr></table></figure>
<p>@Entity<br>@Getter<br>@Setter<br>@NoArgsConstructor<br>public class WorkerId {</p>
<pre><code>@Id
@GeneratedValue(strategy = GenerationType.AUTO)
private Long id;

@Column(unique = true)
private String serviceKey;
</code></pre><p>}</p>
<p>@Repository<br>public interface WorkerIdRepository extends JpaRepository<workerid, long=""> {<br>    WorkerId findByServiceKey(String serviceKey);<br>}</workerid,></p>
<p>@Service<br>@AllArgsConstructor<br>@Slf4j<br>public class WorkerIdService {</p>
<pre><code>private final WorkerIdRepository workerIdRepository;
private final Registration registration;

Long getWorkerId() {

    String serviceKey = getServiceKey();

    WorkerId workerId = workerIdRepository.findByServiceKey(serviceKey);

    if (workerId != null) {
        return workerId.getId() % (SnowFlake.MAX_MACHINE_NUM + 1);
    }

    workerId = new WorkerId();
    // 如果你的 Spring Boot 版本 &gt;= 2.1.0 并且使用的 Discovery 提供了该方法的实现则可以直接使用
    // workerId.setServiceKey(registration.getInstanceId());
    workerId.setServiceKey(serviceKey);
    workerIdRepository.save(workerId);
    return workerId.getId() % (SnowFlake.MAX_MACHINE_NUM + 1);
}

/**
 * 由于 Spring Cloud Discovery 的 ServiceInstance 接口没有一个获取 instance id 的方法，所以只能想办法自己标记
 * Spring Cloud Discovery 在 2.1.0 之后的版本在接口中提供了 getInstanceId 这一方法，但是可以为空，所以需要各个实现，我看了 K8S 和 consul 都提供了该方法的实现
 * @return ip:mac_address 形式的字符串
 */
public String getServiceKey() {
    byte[] mac = null;
    String hostAddress = null;
    try {

        Enumeration&lt;NetworkInterface&gt; networkInterfaces = NetworkInterface.getNetworkInterfaces();
        while (networkInterfaces.hasMoreElements()) {
            NetworkInterface networkInterface = networkInterfaces.nextElement();
            Enumeration&lt;InetAddress&gt; addresses = networkInterface.getInetAddresses();

            while (addresses.hasMoreElements()) {
                InetAddress addr = addresses.nextElement();
                if (addr instanceof Inet4Address &amp;&amp; !addr.isLoopbackAddress() &amp;&amp; (networkInterface.getDisplayName().equals(&quot;en0&quot;) || networkInterface.getDisplayName().equals(&quot;eth0&quot;))) {
                    hostAddress = addr.getHostAddress();
                    mac = networkInterface.getHardwareAddress();
                    break;
                }
            }
            if (mac != null &amp;&amp; StringUtils.isNotBlank(hostAddress)) {
                break;
            }
        }
    } catch (Exception e) {
        log.error(e.getMessage());
    }
    if (mac == null || StringUtils.isBlank(hostAddress)) {
        return null;
    }
    // mac地址拼装成String
    StringBuilder macAddress = new StringBuilder();
    for (int i = 0; i &lt; mac.length; i++) {
        if (i != 0) {
            macAddress.append(&quot;-&quot;);
        }
        //mac[i] &amp; 0xFF 是为了把byte转化为正整数
        String s = Integer.toHexString(mac[i] &amp; 0xFF);
        macAddress.append(s.length() == 1 ? 0 + s : s);
    }
    // 把字符串所有小写字母改为大写成为正规的mac地址并返回
    return hostAddress + &quot;:&quot; + macAddress.toString().toUpperCase();
}
</code></pre><p>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#24314;&#31435;&#30456;&#24212;&#30340; Entity&#12289;Repository&#12289;Service&#65292;&#20174;&#20195;&#30721;&#20013;&#21487;&#20197;&#30475;&#21040; Worker ID &#30340;&#23454;&#29616;&#65292;&#33719;&#21462; IP &#21644; MAC &#20316;&#20026;&#21807;&#19968; Key &#23384;&#20837;&#25968;&#25454;&#24211;&#65292;&#33719;&#21462;&#21040;&#33258;&#22686; ID&#65292;&#28982;&#21518;&#23545; Snowflake &#30340;&#26368;&#22823; Worker ID &#21462;&#20313;&#65292;&#36825;&#26679;&#20415;&#24471;&#21040;&#20102;&#19968;&#20010;&#21487;&#29992;&#30340; Worker ID&#12290;&#10;&#10;&#28982;&#32780;&#36825;&#20040;&#20570;&#20250;&#19981;&#20250;&#26377;&#38382;&#39064;&#65311;&#30001;&#20110;Worker ID &#22312; 0-1023 &#20043;&#38388;&#21453;&#22797;&#65292;&#22914;&#26524;&#26576;&#20123;&#33410;&#28857;&#21453;&#22797;&#37325;&#21551;&#65292;&#36229;&#36807; 1024 &#27425;&#24182;&#19988;&#19968;&#20123;&#33410;&#28857;&#19968;&#30452;&#27809;&#26377;&#37325;&#21551;&#65292;&#23601;&#20250;&#20986;&#29616; Worker ID &#37325;&#22797;&#30340;&#24773;&#20917;&#12290;&#30001;&#20110;&#25105;&#20204;&#30340;&#19994;&#21153;&#30446;&#21069;&#33410;&#28857;&#30340;&#26356;&#26032;&#19968;&#33324;&#37117;&#26159;&#36880;&#20010;&#20381;&#27425;&#37325;&#21551;&#65292;&#25152;&#20197;&#36825;&#37324;&#26242;&#26102;&#19981;&#21435;&#22788;&#29702;&#36825;&#20010;&#38382;&#39064;&#65292;&#26410;&#26469;&#22914;&#26524;&#38656;&#35201;&#22810;&#20010;&#33410;&#28857;&#36827;&#34892; AB &#27979;&#35797;&#65292;&#36825;&#20010;&#26102;&#20505;&#21487;&#33021;&#23601;&#20250;&#20986;&#29616;&#26576;&#20123;&#33410;&#28857;&#39057;&#32321;&#26356;&#26032;&#65292;&#32780;&#26576;&#20123;&#33410;&#28857;&#19981;&#21464;&#21270;&#30340;&#24773;&#20917;&#65292;&#23626;&#26102;&#21487;&#33021;&#23601;&#35201;&#37325;&#26032;&#32771;&#34385;&#20998;&#37197; ID &#30340;&#26041;&#26696;&#20102;&#12290;&#10;&#10;&#19979;&#38754;&#32487;&#32493;&#23436;&#25104;&#19978;&#38754;&#30340;&#26041;&#26696;&#65292;&#25105;&#20204;&#24050;&#32463;&#20889;&#22909;&#20102;&#30456;&#20851;&#30340; Service &#65292;&#21097;&#19979;&#30340;&#23601;&#26159;&#22312;&#26381;&#21153;&#21551;&#21160;&#30340;&#26102;&#20505;&#21521;&#25968;&#25454;&#24211;&#20889;&#20837;&#20449;&#24687;&#20102;&#12290;</span><br></pre></td></tr></table></figure>
<p>@Component<br>public class UIDGenerator {</p>
<pre><code>private final WorkerIdService workerIdService;
private SnowFlake flake;

@Autowired
public UIDGenerator(WorkerIdService workerIdService) {
    this.workerIdService = workerIdService;
}

public Long getId() {
    return flake.nextId();
}

@PostConstruct
public void init() {
    this.flake = new SnowFlake(workerIdService.getWorkerId());
}
</code></pre><p>}</p>
<p>```</p>
<p>这里我们建立一个 <code>UIDGenerator</code> 作为服务的 ID 生成器，在启动的时候，通过 <code>WorkerIdService</code> 获取到一个 Worker ID，并构建 <code>Snowfalke</code> 对象，至此我们的 ID 生成器就基本完成了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/06/10/UID-Generator/" data-id="cjwqe6jv400036i1d0dxfrwxu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Axon/">Axon</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CQRS/">CQRS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Event-Sourcing/">Event Sourcing</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2019/06/10/Event-Sourcing-And-CQRS/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Event Sourcing And CQRS</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Axon/">Axon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CQRS/">CQRS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Event-Sourcing/">Event Sourcing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/">hexo</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Axon/" style="font-size: 20px;">Axon</a> <a href="/tags/CQRS/" style="font-size: 20px;">CQRS</a> <a href="/tags/Event-Sourcing/" style="font-size: 20px;">Event Sourcing</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/06/10/UID-Generator/">UID Generator</a>
          </li>
        
          <li>
            <a href="/2019/06/10/Event-Sourcing-And-CQRS/">Event Sourcing And CQRS</a>
          </li>
        
          <li>
            <a href="/2016/02/26/Hexo的介绍以及使用/">Hexo的介绍以及使用</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 Jokefaker<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>